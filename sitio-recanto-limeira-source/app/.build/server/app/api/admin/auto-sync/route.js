"use strict";(()=>{var e={};e.id=131,e.ids=[131],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},34586:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>x,serverHooks:()=>v,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>p,POST:()=>f});var i=r(49303),o=r(88716),n=r(60670),a=r(87070),c=r(75571),d=r(90455),u=r(94011),l=r(61086);let h=null;function m(){return h&&h.destroy(),h=u.schedule("0 */4 * * *",async()=>{console.log("\uD83D\uDD04 Iniciando sincroniza\xe7\xe3o autom\xe1tica com Airbnb...");try{let e=await (0,l.Vf)("https://www.airbnb.com/calendar/ical/1472647101580205867.ics?s=b97d414e9cafe42dca0b119cca0a25f7&locale=pt");e.success?console.log(`‚úÖ Sincroniza\xe7\xe3o autom\xe1tica conclu\xedda: ${e.message}`):console.error(`‚ùå Erro na sincroniza\xe7\xe3o autom\xe1tica: ${e.message}`)}catch(e){console.error("‚ùå Erro na sincroniza\xe7\xe3o autom\xe1tica:",e)}},{timezone:"America/Sao_Paulo"}),console.log("\uD83D\uDE80 Sincroniza\xe7\xe3o autom\xe1tica iniciada (a cada 4 horas)"),h}async function p(){try{let e=await (0,c.getServerSession)(d.L);if(!e||e.user?.email!=="admin@sitiorecantodalimeira.com")return a.NextResponse.json({error:"Acesso negado"},{status:401});let t={isRunning:!!h&&"destroyed"!==h.getStatus(),schedule:"0 */4 * * *",timezone:"America/Sao_Paulo"};return a.NextResponse.json(t)}catch(e){return console.error("Erro ao obter status da sincroniza\xe7\xe3o:",e),a.NextResponse.json({error:"Erro interno do servidor"},{status:500})}}async function f(e){try{let t=await (0,c.getServerSession)(d.L);if(!t||t.user?.email!=="admin@sitiorecantodalimeira.com")return a.NextResponse.json({error:"Acesso negado"},{status:401});let{action:r}=await e.json();if("start"===r)return m(),a.NextResponse.json({success:!0,message:"Sincroniza\xe7\xe3o autom\xe1tica iniciada",isRunning:!0});if("stop"===r)return h&&(h.destroy(),h=null,console.log("\uD83D\uDED1 Sincroniza\xe7\xe3o autom\xe1tica parada")),a.NextResponse.json({success:!0,message:"Sincroniza\xe7\xe3o autom\xe1tica parada",isRunning:!1});return a.NextResponse.json({error:"A\xe7\xe3o inv\xe1lida"},{status:400})}catch(e){return console.error("Erro na API de auto-sync:",e),a.NextResponse.json({error:"Erro interno do servidor",details:e instanceof Error?e.message:"Erro desconhecido"},{status:500})}}setTimeout(()=>{m(),console.log("\uD83D\uDE80 Sincroniza\xe7\xe3o autom\xe1tica com Airbnb iniciada automaticamente")},3e4);let x=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/auto-sync/route",pathname:"/api/admin/auto-sync",filename:"route",bundlePath:"app/api/admin/auto-sync/route"},resolvedPagePath:"/home/ubuntu/vercel-deploy/sitio-recanto-limeira-source/app/app/api/admin/auto-sync/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:v}=x,b="/api/admin/auto-sync/route";function w(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:y})}},90455:(e,t,r)=>{r.d(t,{L:()=>d});var s=r(53797),i=r(13539),o=r(53524),n=r(42023),a=r.n(n);let c=new o.PrismaClient,d={adapter:(0,i.N)(c),providers:[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await c.user.findUnique({where:{email:e.email}});return t&&t.password&&await a().compare(e.password,t.password)?{id:t.id,email:t.email,name:t.name,role:t.role}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t.role),e),session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/admin/login"}}},36119:(e,t,r)=>{r.d(t,{V:()=>o});var s=r(72880),i=r.n(s);async function o(e){try{if(!process.env.SENDGRID_API_KEY||"YOUR_SENDGRID_API_KEY_HERE"===process.env.SENDGRID_API_KEY)return console.log("‚ö†Ô∏è SendGrid n\xe3o configurado - email n\xe3o ser\xe1 enviado"),{success:!1,message:"SendGrid n\xe3o configurado"};if(!process.env.NOTIFICATION_EMAIL)return console.log("‚ö†Ô∏è Email de notifica\xe7\xe3o n\xe3o configurado"),{success:!1,message:"Email de notifica\xe7\xe3o n\xe3o configurado"};let t=new Date(e.checkIn).toLocaleDateString("pt-BR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),r=new Date(e.checkOut).toLocaleDateString("pt-BR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s=new Date(e.checkIn),o=new Date(e.checkOut).getTime()-s.getTime(),n=Math.ceil(o/864e5),a=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
      <div style="background: linear-gradient(135deg, #059669, #10b981); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="color: white; margin: 0; font-size: 28px;">üè° Nova Reserva</h1>
        <p style="color: #d1fae5; margin: 10px 0 0 0; font-size: 18px;">S\xedtio Recanto da Limeira</p>
      </div>
      
      <div style="background: white; padding: 30px; border: 1px solid #e5e5e5; border-radius: 0 0 10px 10px;">
        <p style="font-size: 18px; color: #059669; font-weight: bold; margin-bottom: 20px;">
          Uma nova reserva foi realizada atrav\xe9s do ${e.source}!
        </p>
        
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="color: #374151; margin-top: 0; border-bottom: 2px solid #059669; padding-bottom: 10px;">
            üìã Informa\xe7\xf5es da Reserva
          </h3>
          
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; width: 120px;">
                üë§ H\xf3spede:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${e.guestName}
              </td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üìß Email:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                <a href="mailto:${e.guestEmail}" style="color: #059669; text-decoration: none;">
                  ${e.guestEmail}
                </a>
              </td>
            </tr>
            ${e.guestPhone?`
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üì± Telefone:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                <a href="tel:${e.guestPhone}" style="color: #059669; text-decoration: none;">
                  ${e.guestPhone}
                </a>
              </td>
            </tr>
            `:""}
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üìÖ Check-in:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${t}
              </td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üìÖ Check-out:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${r}
              </td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üóìÔ∏è Dura\xe7\xe3o:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${n} ${1===n?"dia":"dias"}
              </td>
            </tr>
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üë• Pessoas:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${e.guests} ${1===e.guests?"pessoa":"pessoas"}
              </td>
            </tr>
            ${e.observations?`
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151; vertical-align: top;">
                üìù Observa\xe7\xf5es:
              </td>
              <td style="padding: 8px 0; color: #6b7280;">
                ${e.observations}
              </td>
            </tr>
            `:""}
            <tr>
              <td style="padding: 8px 0; font-weight: bold; color: #374151;">
                üåê Origem:
              </td>
              <td style="padding: 8px 0;">
                <span style="background: ${"Site"===e.source?"#dcfce7":"#fef3c7"}; 
                           color: ${"Site"===e.source?"#059669":"#d97706"}; 
                           padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 12px;">
                  ${e.source}
                </span>
              </td>
            </tr>
          </table>
        </div>
        
        <div style="background: #f0fdf4; border-left: 4px solid #059669; padding: 15px; margin: 20px 0;">
          <p style="margin: 0; color: #374151; font-weight: bold;">
            üí° Pr\xf3ximos passos:
          </p>
          <p style="margin: 10px 0 0 0; color: #6b7280;">
            Entre em contato com o h\xf3spede para acertar detalhes, valores e confirmar a reserva.
          </p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
          <a href="${process.env.NEXTAUTH_URL||"http://localhost:3000"}/admin/login" 
             style="background: #059669; color: white; padding: 12px 24px; text-decoration: none; 
                    border-radius: 6px; font-weight: bold; display: inline-block;">
            üîß Acessar Painel Administrativo
          </a>
        </div>
        
        <hr style="border: none; border-top: 1px solid #e5e5e5; margin: 30px 0;">
        
        <p style="text-align: center; color: #9ca3af; font-size: 14px; margin: 0;">
          Este \xe9 um email autom\xe1tico do sistema de reservas do S\xedtio Recanto da Limeira.
        </p>
      </div>
    </div>
    `,c={to:process.env.NOTIFICATION_EMAIL,from:{email:process.env.NOTIFICATION_EMAIL,name:"S\xedtio Recanto da Limeira"},subject:`üè° Nova Reserva - ${e.guestName} (${e.source})`,html:a};return await i().send(c),console.log(`‚úÖ Email de notifica\xe7\xe3o enviado para ${process.env.NOTIFICATION_EMAIL}`),{success:!0,message:"Email enviado com sucesso"}}catch(e){return console.error("‚ùå Erro ao enviar email:",e),{success:!1,message:e instanceof Error?e.message:"Erro desconhecido ao enviar email"}}}process.env.SENDGRID_API_KEY&&i().setApiKey(process.env.SENDGRID_API_KEY)},61086:(e,t,r)=>{r.d(t,{Hy:()=>u,Vf:()=>d});var s=r(53524),i=r(3442),o=r.n(i),n=r(36119);let a=new s.PrismaClient;async function c(e){try{let t=o().parseICS(e),r=[];return Object.values(t).forEach(e=>{if("VEVENT"===e.type&&e.start&&e.end){let t=new Date(e.start).toISOString().split("T")[0],s=new Date(e.end).toISOString().split("T")[0];r.push({startDate:t,endDate:s,summary:e.summary||"Reserva Airbnb",uid:e.uid||`airbnb-${t}-${s}`})}}),r}catch(e){throw console.error("Erro ao processar iCal:",e),e}}async function d(e){try{let t=await fetch(e);if(!t.ok)throw Error(`Erro ao buscar iCal: ${t.status}`);let r=await t.text(),s=await c(r),i=0;for(let e of s)if(!await a.blockedDate.findFirst({where:{startDate:new Date(e.startDate),endDate:new Date(e.endDate),reason:{contains:"Airbnb"}}})){await a.blockedDate.create({data:{startDate:new Date(e.startDate),endDate:new Date(e.endDate),reason:`Reserva Airbnb: ${e.summary}`,createdBy:"airbnb-sync"}});try{let t=e.summary.includes("Reserved")?e.summary.replace("Reserved","").trim():e.summary||"H\xf3spede Airbnb";await (0,n.V)({guestName:t,guestEmail:"N\xe3o informado via Airbnb",guestPhone:"Consultar no Airbnb",checkIn:new Date(e.startDate).toISOString(),checkOut:new Date(e.endDate).toISOString(),guests:4,observations:`Reserva importada automaticamente do Airbnb. UID: ${e.uid}`,source:"Airbnb"}),console.log(`‚úÖ Notifica\xe7\xe3o enviada para nova reserva Airbnb: ${t}`)}catch(e){console.error("‚ö†Ô∏è Erro ao enviar notifica\xe7\xe3o de reserva Airbnb por email:",e)}i++}return{success:!0,bookingsAdded:i,message:`Sincroniza\xe7\xe3o conclu\xedda. ${i} novas reservas adicionadas.`}}catch(e){return console.error("Erro na sincroniza\xe7\xe3o:",e),{success:!1,bookingsAdded:0,message:`Erro na sincroniza\xe7\xe3o: ${e instanceof Error?e.message:"Erro desconhecido"}`}}}async function u(){let e=new Date;e.setDate(e.getDate()-30),await a.blockedDate.deleteMany({where:{endDate:{lt:e},createdBy:"airbnb-sync"}})}},53839:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createID=function(e="",t=16){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=Array.from(i.default.randomBytes(t),e=>r[e%r.length]).join("");return e?`${e}-${s}`:s};let i=s(r(6005))},88604:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});let r={INFO:"\x1b[36m",WARN:"\x1b[33m",ERROR:"\x1b[31m",DEBUG:"\x1b[35m"},s="\x1b[32m";function i(e,t,i){let o=new Date().toISOString(),n=r[e]??"",a=`[${o}] [PID: ${process.pid}] ${s}[NODE-CRON]${s} ${n}[${e}]\x1b[0m`,c=`${a} ${t}`;switch(e){case"ERROR":console.error(c,i??"");break;case"DEBUG":console.debug(c,i??"");break;case"WARN":console.warn(c);break;default:console.info(c)}}t.default={info(e){i("INFO",e)},warn(e){i("WARN",e)},error(e,t){e instanceof Error?i("ERROR",e.message,e):i("ERROR",e,t)},debug(e,t){e instanceof Error?i("DEBUG",e.message,e):i("DEBUG",e,t)}}},94011:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.nodeCron=t.getTask=t.getTasks=void 0,t.schedule=l,t.createTask=h,t.solvePath=m,t.validate=p;let i=r(26363),o=r(14399),n=s(r(49892)),a=s(r(83403)),c=s(r(55315)),d=r(17360),u=new o.TaskRegistry;function l(e,t,r){let s=h(e,t,r);return s.start(),s}function h(e,t,r){let s;if(t instanceof Function)s=new i.InlineScheduledTask(e,t,r);else{let i=m(t);s=new a.default(e,i,r)}return u.add(s),s}function m(e){if(c.default.isAbsolute(e))return(0,d.pathToFileURL)(e).href;if(e.startsWith("file://"))return e;let t=Error().stack?.split("\n");if(t){t?.shift();let r=t?.find(e=>e.indexOf(__filename)===-1),s=r?.match(/(file:\/\/)?(((\/?)(\w:))?([/\\].+)):\d+:\d+/);if(s){let t=`${s[5]??""}${c.default.dirname(s[6])}`;return(0,d.pathToFileURL)(c.default.resolve(t,e)).href}}throw Error(`Could not locate task file ${e}`)}function p(e){try{return(0,n.default)(e),!0}catch(e){return!1}}t.getTasks=u.all,t.getTask=u.get,t.nodeCron={schedule:l,createTask:h,validate:p,getTasks:t.getTasks,getTask:t.getTask},t.default=t.nodeCron},4966:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(()=>{function e(e,t){return -1!==e.indexOf("*")?e.replace("*",t):e}return function(t){return t[0]=e(t[0],"0-59"),t[1]=e(t[1],"0-59"),t[2]=e(t[2],"0-23"),t[3]=e(t[3],"1-31"),t[4]=e(t[4],"1-12"),t[5]=e(t[5],"0-6"),t}})()},24519:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});let i=s(r(79256)),o=s(r(31416)),n=s(r(4966)),a=s(r(66622));t.default=function(e){var t;let r=`${e}`.replace(/\s{2,}/g," ").trim().split(" ");return(r=5===(t=r).length?["0"].concat(t):t)[4]=(0,i.default)(r[4]),r[5]=(0,o.default)(r[5]),r=(0,n.default)(r),r=function(e){for(let t=0;t<e.length;t++){let r=e[t].split(",");for(let e=0;e<r.length;e++)r[e]=parseInt(r[e]);e[t]=r}return e}(r=(0,a.default)(r))}},79256:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(()=>{let e=["january","february","march","april","may","june","july","august","september","october","november","december"],t=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];function r(e,t){for(let r=0;r<t.length;r++)e=e.replace(RegExp(t[r],"gi"),r+1);return e}return function(s){return s=r(s,e),s=r(s,t)}})()},66622:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(let t=0;t<e.length;t++)e[t]=function(e){let t=/(\d+)-(\d+)(\/(\d+)|)/,r=t.exec(e);for(;null!==r&&r.length>0;)r=t.exec(e=function(e,t,r,s,i){let o=parseInt(i),n=[],a=parseInt(s),c=parseInt(r);c>a&&(a=parseInt(r),c=parseInt(s));for(let e=c;e<=a;e+=o)n.push(e);return e.replace(RegExp(t,"i"),n.join())}(e,r[0],r[1],r[2],r[4]||"1"));return e}(e[t]);return e}},31416:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=(()=>{let e=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],t=["sun","mon","tue","wed","thu","fri","sat"];function r(e,t){for(let r=0;r<t.length;r++)e=e.replace(RegExp(t[r],"gi"),r);return e}return function(s){return s=r(s=s.replace("7","0"),e),r(s,t)}})()},49892:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});let i=s(r(24519)),o=/^(?:\d+|\*|\*\/\d+)$/;function n(e,t,r){for(let s of e){let e=parseInt(s,10);if(!Number.isNaN(e)&&(e<t||e>r)||!o.test(s))return!1}return!0}t.default=function(e){if("string"!=typeof e)throw TypeError("pattern must be a string!");let t=e.split(" "),r=(0,i.default)(e);5===t.length&&t.unshift("0"),function(e,t){if(!n(t[0],0,59))throw Error(`${e[0]} is a invalid expression for second`);if(!n(t[1],0,59))throw Error(`${e[1]} is a invalid expression for minute`);if(!n(t[2],0,23))throw Error(`${e[2]} is a invalid expression for hour`);if(!n(t[3],1,31))throw Error(`${e[3]} is a invalid expression for day of month`);if(!n(t[4],1,12))throw Error(`${e[4]} is a invalid expression for month`);if(!n(t[5],0,7))throw Error(`${e[5]} is a invalid expression for week day`)}(t,r)}},6622:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TrackedPromise=void 0;class r{promise;error;state;value;constructor(e){this.state="pending",this.promise=new Promise((t,r)=>{e(e=>{this.state="fulfilled",this.value=e,t(e)},e=>{this.state="rejected",this.error=e,r(e)})})}getPromise(){return this.promise}getState(){return this.state}isPending(){return"pending"===this.state}isFulfilled(){return"fulfilled"===this.state}isRejected(){return"rejected"===this.state}getValue(){return this.value}getError(){return this.error}then(e,t){return this.promise.then(e,t)}catch(e){return this.promise.catch(e)}finally(e){return this.promise.finally(e)}}t.TrackedPromise=r},33394:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Runner=void 0;let i=r(53839),o=s(r(88604)),n=r(6622);function a(){}function c(){return!0}function d(e,t){o.default.error("Task failed with error!",t)}class u{timeMatcher;onMatch;noOverlap;maxExecutions;maxRandomDelay;runCount;running;heartBeatTimeout;onMissedExecution;onOverlap;onError;beforeRun;onFinished;onMaxExecutions;constructor(e,t,r){this.timeMatcher=e,this.onMatch=t,this.noOverlap=void 0!=r&&void 0!==r.noOverlap&&r.noOverlap,this.maxExecutions=r?.maxExecutions,this.maxRandomDelay=r?.maxRandomDelay||0,this.onMissedExecution=r?.onMissedExecution||a,this.onOverlap=r?.onOverlap||a,this.onError=r?.onError||d,this.onFinished=r?.onFinished||c,this.beforeRun=r?.beforeRun||c,this.onMaxExecutions=r?.onMaxExecutions||a,this.runCount=0,this.running=!1}start(){let e,t;this.running=!0;let r=e=>{this.running&&(clearTimeout(this.heartBeatTimeout),this.heartBeatTimeout=setTimeout(c,h(this.timeMatcher,e)))},s=e=>new Promise(async t=>{let r={id:(0,i.createID)("exec"),reason:"scheduled"},s=await this.beforeRun(e,r),o=Math.floor(Math.random()*this.maxRandomDelay);s&&setTimeout(async()=>{try{this.runCount++,r.startedAt=new Date;let t=await this.onMatch(e,r);r.finishedAt=new Date,r.result=t,this.onFinished(e,r),this.maxExecutions&&this.runCount>=this.maxExecutions&&(this.onMaxExecutions(e),this.stop())}catch(t){r.finishedAt=new Date,r.error=t,this.onError(e,t,r)}t(!0)},o)}),a=e=>new n.TrackedPromise(async(t,r)=>{try{this.timeMatcher.match(e)&&await s(e),t(!0)}catch(e){r(e)}}),c=async()=>{let s=m();if(t&&t.getTime()<s.getTime())for(;t.getTime()<s.getTime();)o.default.warn(`missed execution at ${t}! Possible blocking IO or high CPU user at the same process used by node-cron.`),t=this.timeMatcher.getNextMatch(t),l(this.onMissedExecution,t,d);if(e&&"pending"===e.getState()&&(l(this.onOverlap,s,d),this.noOverlap)){o.default.warn("task still running, new execution blocked by overlap prevention!"),t=this.timeMatcher.getNextMatch(s),r(s);return}e=a(s),t=this.timeMatcher.getNextMatch(s),r(s)};this.heartBeatTimeout=setTimeout(()=>{c()},h(this.timeMatcher,m()))}nextRun(){return this.timeMatcher.getNextMatch(new Date)}stop(){this.running=!1,this.heartBeatTimeout&&(clearTimeout(this.heartBeatTimeout),this.heartBeatTimeout=void 0)}isStarted(){return!!this.heartBeatTimeout&&this.running}isStopped(){return!this.isStarted()}async execute(){let e=new Date,t={id:(0,i.createID)("exec"),reason:"invoked"};try{if(await this.beforeRun(e,t)){this.runCount++,t.startedAt=new Date;let r=await this.onMatch(e,t);t.finishedAt=new Date,t.result=r,this.onFinished(e,t)}}catch(r){t.finishedAt=new Date,t.error=r,this.onError(e,r,t)}}}async function l(e,t,r){try{await e(t)}catch(e){r(t,e)}}function h(e,t){let r=e.getNextMatch(t),s=new Date,i=r.getTime()-s.getTime();return i>864e5?864e5:Math.max(0,i)}function m(){let e=new Date;return e.setMilliseconds(0),e}t.Runner=u},14399:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TaskRegistry=void 0;let r=new Map;class s{add(e){if(this.has(e.id))throw Error(`task ${e.id} already registred!`);r.set(e.id,e),e.on("task:destroyed",()=>{this.remove(e)})}get(e){return r.get(e)}remove(e){this.has(e.id)&&(e?.destroy(),r.delete(e.id))}all(){return r}has(e){return r.has(e)}killAll(){r.forEach(e=>this.remove(e))}}t.TaskRegistry=s},83403:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});let i=r(55315),o=r(61282),n=r(53839),a=r(76162),c=r(33214),d=r(44485),u=s(r(88604)),l=r(57784),h=(0,i.resolve)(__dirname,"daemon.js");class m extends a.EventEmitter{}class p{emitter;id;name;cronExpression;taskPath;options;forkProcess;stateMachine;constructor(e,t,r){this.cronExpression=e,this.taskPath=t,this.options=r,this.id=(0,n.createID)("task"),this.name=r?.name||this.id,this.emitter=new m,this.stateMachine=new c.StateMachine("stopped"),this.on("task:stopped",()=>{this.forkProcess?.kill(),this.forkProcess=void 0,this.stateMachine.changeState("stopped")}),this.on("task:destroyed",()=>{this.forkProcess?.kill(),this.forkProcess=void 0,this.stateMachine.changeState("destroyed")})}getNextRun(){return"stopped"!==this.stateMachine.state?new l.TimeMatcher(this.cronExpression,this.options?.timezone).getNextMatch(new Date):null}start(){return new Promise((e,t)=>{if(this.forkProcess)return e(void 0);let r=setTimeout(()=>{t(Error("Start operation timed out"))},5e3);try{this.forkProcess=(0,o.fork)(h),this.forkProcess.on("error",e=>{clearTimeout(r),t(Error(`Error on daemon: ${e.message}`))}),this.forkProcess.on("exit",(e,s)=>{if(0!==e&&"SIGTERM"!==s){let i=Error(`node-cron daemon exited with code ${e||s}`);u.default.error(i),clearTimeout(r),t(i)}}),this.forkProcess.on("message",e=>{if(e.jsonError&&e.context?.execution&&(e.context.execution.error=function(e){let t=JSON.parse(e),r=new(globalThis[t.name]||Error)(t.message);return t.stack&&(r.stack=t.stack),Object.keys(t).forEach(e=>{["name","message","stack"].includes(e)||(r[e]=t[e])}),r}(e.jsonError),delete e.jsonError),e.context?.task?.state&&this.stateMachine.changeState(e.context?.task?.state),e.context){let t=e.context?.execution;delete t?.hasError;let r=this.createContext(new Date(e.context.date),t);this.emitter.emit(e.event,r)}}),this.once("task:started",()=>{this.stateMachine.changeState("idle"),clearTimeout(r),e(void 0)}),this.forkProcess.send({command:"task:start",path:this.taskPath,cron:this.cronExpression,options:this.options})}catch(e){t(e)}})}stop(){return new Promise((e,t)=>{if(!this.forkProcess)return e(void 0);let r=setTimeout(()=>{clearTimeout(r),t(Error("Stop operation timed out"))},5e3),s=()=>{clearTimeout(r),this.off("task:stopped",i),this.forkProcess=void 0,e(void 0)},i=()=>{s()};this.once("task:stopped",i),this.forkProcess.send({command:"task:stop"})})}getStatus(){return this.stateMachine.state}destroy(){return new Promise((e,t)=>{if(!this.forkProcess)return e(void 0);let r=setTimeout(()=>{clearTimeout(r),t(Error("Destroy operation timed out"))},5e3),s=()=>{clearTimeout(r),this.off("task:destroyed",s),e(void 0)};this.once("task:destroyed",s),this.forkProcess.send({command:"task:destroy"})})}execute(){return new Promise((e,t)=>{if(!this.forkProcess)return t(Error("Cannot execute background task because it hasn't been started yet. Please initialize the task using the start() method before attempting to execute it."));let r=setTimeout(()=>{s(),t(Error("Execution timeout exceeded"))},5e3),s=()=>{clearTimeout(r),this.off("execution:finished",i),this.off("execution:failed",o)},i=t=>{s(),e(t.execution?.result)},o=e=>{s(),t(e.execution?.error||Error("Execution failed without specific error"))};this.once("execution:finished",i),this.once("execution:failed",o),this.forkProcess.send({command:"task:execute"})})}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}once(e,t){this.emitter.once(e,t)}createContext(e,t){let r=new d.LocalizedTime(e,this.options?.timezone);return{date:r.toDate(),dateLocalIso:r.toISO(),triggeredAt:new Date,task:this,execution:t}}}t.default=p},26363:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.InlineScheduledTask=void 0;let i=s(r(17702)),o=r(33394),n=r(57784),a=r(53839),c=r(33214),d=s(r(88604)),u=r(44485);class l extends i.default{}class h{emitter;cronExpression;timeMatcher;runner;id;name;stateMachine;timezone;constructor(e,t,r){this.emitter=new l,this.cronExpression=e,this.id=(0,a.createID)("task",12),this.name=r?.name||this.id,this.timezone=r?.timezone,this.timeMatcher=new n.TimeMatcher(e,r?.timezone),this.stateMachine=new c.StateMachine;let s={timezone:r?.timezone,noOverlap:r?.noOverlap,maxExecutions:r?.maxExecutions,maxRandomDelay:r?.maxRandomDelay,beforeRun:(e,t)=>("scheduled"===t.reason&&this.changeState("running"),this.emitter.emit("execution:started",this.createContext(e,t)),!0),onFinished:(e,t)=>("scheduled"===t.reason&&this.changeState("idle"),this.emitter.emit("execution:finished",this.createContext(e,t)),!0),onError:(e,t,r)=>{d.default.error(t),this.emitter.emit("execution:failed",this.createContext(e,r)),this.changeState("idle")},onOverlap:e=>{this.emitter.emit("execution:overlap",this.createContext(e))},onMissedExecution:e=>{this.emitter.emit("execution:missed",this.createContext(e))},onMaxExecutions:e=>{this.emitter.emit("execution:maxReached",this.createContext(e)),this.destroy()}};this.runner=new o.Runner(this.timeMatcher,(e,r)=>t(this.createContext(e,r)),s)}getNextRun(){return"stopped"!==this.stateMachine.state?this.runner.nextRun():null}changeState(e){this.runner.isStarted()&&this.stateMachine.changeState(e)}start(){this.runner.isStopped()&&(this.runner.start(),this.stateMachine.changeState("idle"),this.emitter.emit("task:started",this.createContext(new Date)))}stop(){this.runner.isStarted()&&(this.runner.stop(),this.stateMachine.changeState("stopped"),this.emitter.emit("task:stopped",this.createContext(new Date)))}getStatus(){return this.stateMachine.state}destroy(){"destroyed"!==this.stateMachine.state&&(this.stop(),this.stateMachine.changeState("destroyed"),this.emitter.emit("task:destroyed",this.createContext(new Date)))}execute(){return new Promise((e,t)=>{let r=e=>{this.off("execution:finished",r),t(e.execution?.error)};this.once("execution:finished",t=>{this.off("execution:failed",r),e(t.execution?.result)}),this.once("execution:failed",r),this.runner.execute()})}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}once(e,t){this.emitter.once(e,t)}createContext(e,t){let r=new u.LocalizedTime(e,this.timezone);return{date:r.toDate(),dateLocalIso:r.toISO(),triggeredAt:new Date,task:this,execution:t}}}t.InlineScheduledTask=h},33214:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StateMachine=void 0;let r={stopped:["stopped","idle","destroyed"],idle:["idle","running","stopped","destroyed"],running:["running","idle","stopped","destroyed"],destroyed:["destroyed"]};class s{state;constructor(e="stopped"){this.state=e}changeState(e){if(r[this.state].includes(e))this.state=e;else throw Error(`invalid transition from ${this.state} to ${e}`)}}t.StateMachine=s},44485:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LocalizedTime=void 0;class r{timestamp;parts;timezone;constructor(e,t){this.timestamp=e.getTime(),this.timezone=t,this.parts=s(e,t)}toDate(){return new Date(this.timestamp)}toISO(){let e=this.parts.gmt.replace(/^GMT/,""),t=e=>String(e).padStart(2,"0");return`${this.parts.year}-${t(this.parts.month)}-${t(this.parts.day)}T${t(this.parts.hour)}:${t(this.parts.minute)}:${t(this.parts.second)}.${String(this.parts.milisecond).padStart(3,"0")}`+(e||"Z")}getParts(){return this.parts}set(e,t){this.parts[e]=t;let r=new Date(this.toISO());this.timestamp=r.getTime(),this.parts=s(r,this.timezone)}}function s(e,t){let r={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",weekday:"short",hour12:!1};t&&(r.timeZone=t);let s=new Intl.DateTimeFormat("en-US",r).formatToParts(e).filter(e=>"literal"!==e.type).reduce((e,t)=>(e[t.type]=t.value,e),{});return{day:parseInt(s.day),month:parseInt(s.month),year:parseInt(s.year),hour:"24"===s.hour?0:parseInt(s.hour),minute:parseInt(s.minute),second:parseInt(s.second),milisecond:e.getMilliseconds(),weekday:s.weekday,gmt:function(e,t){let r=new Date(e.toLocaleString("en-US",{timeZone:"UTC"})),s=new Date(e.toLocaleString("en-US",{timeZone:t})),i=(r.getTime()-s.getTime())/6e4,o=i<=0?"+":"-";if(0===(i=Math.abs(i)))return"Z";let n=Math.floor(i/60).toString().padStart(2,"0"),a=Math.floor(i%60).toString().padStart(2,"0");return`GMT${o}${n}:${a}`}(e,t)}}t.LocalizedTime=r},35470:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MatcherWalker=void 0;let i=s(r(24519)),o=r(44485),n=r(57784),a=s(r(31416));class c{cronExpression;baseDate;pattern;expressions;timeMatcher;timezone;constructor(e,t,r){this.cronExpression=e,this.baseDate=t,this.timeMatcher=new n.TimeMatcher(e,r),this.timezone=r,this.expressions=(0,i.default)(e)}isMatching(){return this.timeMatcher.match(this.baseDate)}matchNext(){let e=(()=>{let e=new Date(this.baseDate.getTime());e.setMilliseconds(0);let t=new o.LocalizedTime(e,this.timezone),r=t.getParts(),s=new o.LocalizedTime(t.toDate(),this.timezone),i=this.expressions[0],n=d(i,r.second);if(n&&(s.set("second",n),this.timeMatcher.match(s.toDate())))return s;s.set("second",i[0]);let a=this.expressions[1],c=d(a,r.minute);if(c&&(s.set("minute",c),this.timeMatcher.match(s.toDate())))return s;s.set("minute",a[0]);let u=this.expressions[2],l=d(u,r.hour);if(l&&(s.set("hour",l),this.timeMatcher.match(s.toDate())))return s;s.set("hour",u[0]);let h=this.expressions[3],m=d(h,r.day);if(m&&(s.set("day",m),this.timeMatcher.match(s.toDate())))return s;s.set("day",h[0]);let p=this.expressions[4],f=d(p,r.month);return f&&(s.set("month",f),this.timeMatcher.match(s.toDate()))||(s.set("year",s.getParts().year+1),s.set("month",p[0])),s})(),t=this.expressions[5],r=parseInt((0,a.default)(e.getParts().weekday));for(;!(t.indexOf(r)>-1);)e.set("year",e.getParts().year+1),r=parseInt((0,a.default)(e.getParts().weekday));return e}}function d(e,t){let r=e.sort((e,t)=>e-t).filter(e=>e>t);return r.length>0&&r[0]}t.MatcherWalker=c},57784:function(e,t,r){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TimeMatcher=void 0;let i=s(r(24519)),o=s(r(31416)),n=r(44485),a=r(35470);function c(e,t){return -1!==e.indexOf(t)}class d{timezone;pattern;expressions;constructor(e,t){this.timezone=t,this.pattern=e,this.expressions=(0,i.default)(e)}match(e){let t=new n.LocalizedTime(e,this.timezone).getParts(),r=c(this.expressions[0],t.second),s=c(this.expressions[1],t.minute),i=c(this.expressions[2],t.hour),a=c(this.expressions[3],t.day),d=c(this.expressions[4],t.month),u=c(this.expressions[5],parseInt((0,o.default)(t.weekday)));return r&&s&&i&&a&&d&&u}getNextMatch(e){return new a.MatcherWalker(this.pattern,e,this.timezone).matchNext().toDate()}}t.TimeMatcher=d}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,23,637,880,442],()=>r(34586));module.exports=s})();